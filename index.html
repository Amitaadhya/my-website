
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QUINCE PO Data Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #6a11cb; --secondary: #2575fc; --dark: #0f172a; --darker: #0b1120;
      --light: #f8fafc; --accent: #f43f5e; --success: #10b981; --warning: #f59e0b;
      --info: #3b82f6; --purple: #8b5cf6; --pink: #ec4899; --cyan: #06b6d4;
      --particle-float-x: 1000px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, var(--dark), var(--darker));
      color: var(--light); min-height: 100vh; display: flex; flex-direction: column;
      line-height: 1.6; overflow-x: hidden;
    }
    .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
    .particle { position: absolute; background: rgba(255, 255, 255, 0.4); border-radius: 50%; pointer-events: none; animation: float 15s infinite linear; filter: blur(1px); }
    @keyframes float {
      0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-1000px) translateX(var(--particle-float-x)) rotate(720deg); opacity: 0; }
    }
    header {
      width: 100%; padding: 15px 30px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
      position: fixed; top: 0; left: 0; z-index: 999; display: flex; justify-content: space-between;
      align-items: center; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo i { font-size: 1.8rem; color: var(--accent); }
    h1 {
      font-size: 1.8rem; font-weight: 700; background: linear-gradient(90deg, var(--accent), #f472b6, #a78bfa);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      background-size: 300% 300%; animation: gradient 8s ease infinite;
    }
    @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    
    .header-info { display: flex; align-items: center; gap: 20px; }
    .header-info p { margin: 0; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); display: flex; align-items: center; gap: 8px; }
    .header-info #userName.admin-user {
        color: var(--warning);
        font-weight: 600;
        padding: 5px 10px;
        background-color: rgba(245, 158, 11, 0.1);
        border-radius: 20px;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .header-info #userName.admin-user .username-text { color: var(--light); }
    .header-info #clock i { color: var(--cyan); }


    .header-buttons { display: flex; gap: 10px; }
    .header-btn {
      padding: 8px 15px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff;
      border: none; border-radius: 30px; cursor: pointer; font-size: 0.8rem; font-weight: 500;
      transition: all 0.3s ease; display: flex; align-items: center; gap: 5px;
      box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3);
    }
    .header-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(106, 17, 203, 0.4); }
    .header-btn i { font-size: 0.9rem; }
    #userManagementBtn, #portalSettingsBtn { display: none; } 

    .popup {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center;
      z-index: 1000; animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .popup-content {
      background: linear-gradient(145deg, #1e1e2e, #2a2a3e); padding: 30px; border-radius: 15px;
      width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      animation: popupFadeIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(255, 255, 255, 0.1); position: relative; 
    }
    @keyframes popupFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .popup-header { color: #fff; font-size: 1.5rem; margin-bottom: 20px; text-align: center; font-weight: 600; }
    
    .login-footer {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
        text-align: center;
        width: 100%;
        padding: 0 20px;
    }

    .input-group { margin-bottom: 20px; position: relative; }
    .input-group label { display: block; color: rgba(255, 255, 255, 0.8); margin-bottom: 8px; font-size: 0.9rem; }
    .input-group label i { margin-right: 8px; color: var(--info); }
    .input-group input, .input-group select, .input-group textarea {
      width: 100%; padding: 12px 15px; background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; font-size: 1rem; color: #fff;
      transition: all 0.3s ease;
    }
    .input-group input[type="color"] { padding: 5px; height: 45px; cursor: pointer; }
    .input-group textarea { min-height: 150px; resize: vertical; }
    .input-group select option { background-color: var(--darker); color: var(--light); }
    .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
      outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
    }
    .checkbox-group { display: flex; align-items: center; margin-bottom: 20px; }
    .checkbox-group input[type="checkbox"] { margin-right: 10px; accent-color: var(--primary); transform: scale(1.1); }
    .checkbox-group label { color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; cursor: pointer; }
    .login-btn, .action-btn {
      width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer;
      transition: all 0.3s ease; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3);
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .login-btn:hover, .action-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(106, 17, 203, 0.4); }
    .action-btn.secondary { background: linear-gradient(135deg, var(--accent), var(--pink)); box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3); }
    .action-btn.secondary:hover { box-shadow: 0 6px 20px rgba(244, 63, 94, 0.4); }
    .action-btn.danger { background: linear-gradient(135deg, #e53935, #b71c1c); box-shadow: 0 4px 15px rgba(229, 57, 53, 0.3); }
    .action-btn.danger:hover { box-shadow: 0 6px 20px rgba(229, 57, 53, 0.4); }

    .forgot-password { text-align: center; margin-top: 10px; margin-bottom: 30px; }
    .forgot-password a { color: var(--accent); text-decoration: none; font-size: 0.9rem; transition: all 0.3s ease; }
    .forgot-password a:hover { text-decoration: underline; }
    .error-message, .success-message, .warning-message {
      font-size: 0.9rem; margin-top: 10px; text-align: center; display: none; padding: 10px 15px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .error-message { color: #ff6b6b; background-color: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255,107,107,0.3); }
    .success-message { color: var(--success); background-color: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16,185,129,0.3); }
    .warning-message { color: var(--warning); background-color: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245,158,11,0.3); }


    .container { display: none; flex: 1; max-width: 1400px; width: 100%; padding: 100px 20px 40px; margin: 0 auto; }
    
    #dashboardOverviewSection, #recentLinksSection { display: none; }

    .dashboard-overview { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .overview-card {
      background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; position: relative;
    }
    .overview-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
    .overview-card h3 { font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .overview-card h3 i:first-of-type { font-size: 1rem; }
    .overview-card p { font-size: 1.5rem; font-weight: 600; margin: 0; }
    .overview-card .card-value { transition: color 0.3s ease; }
    .overview-card .card-unit { font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-left: 5px;}
    .overview-card .card-footer { font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-top: 10px; display: flex; align-items: center; gap: 5px; }
    .edit-card-btn {
        margin-left: auto; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 0.9em; transition: color 0.3s ease;
        display: none; 
    }
    .edit-card-btn:hover { color: var(--accent); }
    body.admin-mode .edit-card-btn { display: inline-block; }


    .search-filter-container { display: flex; justify-content: space-between; margin-bottom: 30px; gap: 20px; flex-wrap: wrap; }
    .search-container { flex: 1; min-width: 250px; }
    .search-bar { position: relative; width: 100%; }
    .search-bar input {
      width: 100%; padding: 12px 15px 12px 45px; background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 30px; font-size: 0.9rem; color: #fff;
      transition: all 0.3s ease;
    }
    .search-bar input:focus { outline: none; background: rgba(255, 255, 255, 0.15); box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2); }
    .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, 0.7); font-size: 1rem; }
    .filter-tags { display: flex; gap: 10px; flex-wrap: wrap; }
    .filter-tag {
      padding: 8px 15px; background: rgba(255, 255, 255, 0.1); border-radius: 30px; font-size: 0.8rem;
      cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .filter-tag:hover, .filter-tag.active { background: linear-gradient(135deg, var(--primary), var(--secondary)); box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3); }

    .section-header { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .section-header h2 { font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .section-header h2 i { color: var(--accent); }
    .section-header .action-btn-small {
        padding: 6px 12px; font-size: 0.8rem; background: var(--dark); border: 1px solid rgba(255,255,255,0.2);
        color: rgba(255,255,255,0.8); border-radius: 20px; display: flex; align-items: center; gap: 6px;
    }
    .section-header .action-btn-small:hover { background: var(--accent); color: white; border-color: var(--accent); }


    .button-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .btn {
      position: relative; display: flex; align-items: center; padding: 18px 20px; color: #fff;
      border-radius: 12px; text-decoration: none; font-size: 0.9rem; font-weight: 500;
      transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), filter 0.3s ease;
      overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); border: none; cursor: pointer; z-index: 1;
    }
    .btn::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent); z-index: -1; transition: all 0.3s ease;
    }
    .btn::after {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: inherit; z-index: -2; border-radius: inherit;
    }
    .btn:not(.globally-disabled-admin-view):hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
    .btn:not(.globally-disabled-admin-view):hover::before { background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent); }
    .btn i:first-child { margin-right: 12px; font-size: 1.2rem; min-width: 20px; text-align: center; }
    .btn .btn-text { flex-grow: 1; text-align: left; margin-right: 5px; }
    .btn-tag {
      position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.3);
      padding: 3px 8px; border-radius: 30px; font-size: 0.7rem; font-weight: 500;
    }

    body.admin-mode .btn.globally-disabled-admin-view {
      opacity: 0.6; filter: grayscale(60%) brightness(0.7); cursor: default;
    }
    body.admin-mode .btn.globally-disabled-admin-view:hover { transform: none; }
    body.admin-mode .btn.globally-disabled-admin-view::before { display: none; }

    .admin-toggle { margin-left: auto; padding-left: 10px; font-size: 1.3em; cursor: pointer; z-index: 5; display: none; }
    body.admin-mode .admin-toggle { display: inline-block; }
    .admin-toggle i.fa-toggle-on { color: var(--accent); }
    .admin-toggle i.fa-toggle-off { color: var(--success); }

    .btn-1 { background: linear-gradient(135deg, #6a11cb, #2575fc); } .btn-2 { background: linear-gradient(135deg, #ec4899, #f43f5e); }
    .btn-3 { background: linear-gradient(135deg, #10b981, #059669); } .btn-4 { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .btn-5 { background: linear-gradient(135deg, #f59e0b, #d97706); } .btn-6 { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .btn-7 { background: linear-gradient(135deg, #06b6d4, #0891b2); } .btn-8 { background: linear-gradient(135deg, #f97316, #ea580c); }
    .btn-9 { background: linear-gradient(135deg, #e879f9, #c026d3); } .btn-10 { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
    .btn-11 { background: linear-gradient(135deg, #84cc16, #65a30d); } .btn-12 { background: linear-gradient(135deg, #facc15, #eab308); }
    .btn-13 { background: linear-gradient(135deg, #a855f7, #9333ea); } .btn-14 { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
    .btn-15 { background: linear-gradient(135deg, #f472b6, #ec4899); } .btn-16 { background: linear-gradient(135deg, #2dd4bf, #14b8a6); }
    .btn-17 { background: linear-gradient(135deg, #34d399, #10b981); } .btn-18 { background: linear-gradient(135deg, #fb923c, #f97316); }
    .btn-19 { background: linear-gradient(135deg, #818cf8, #6366f1); } .btn-20 { background: linear-gradient(135deg, #a78bfa, #8b5cf6); }
    .btn-21 { background: linear-gradient(135deg, #38bdf8, #0ea5e9); } .btn-22 { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .btn-23 { background: linear-gradient(135deg, #22d3ee, #06b6d4); } .btn-24 { background: linear-gradient(135deg, #c084fc, #a855f7); }
    .btn-25 { background: linear-gradient(135deg, #4f46e5, #4338ca); } .btn-26 { background: linear-gradient(135deg, #f43f5e, #e11d48); }
    .btn-27 { background: linear-gradient(135deg, #14b8a6, #0d9488); } .btn-28 { background: linear-gradient(135deg, #f59e0b, #d97706); }


    .quick-access { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
    .quick-btn {
      padding: 10px 20px; background: rgba(255, 255, 255, 0.1); border-radius: 30px; font-size: 0.9rem;
      cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex; align-items: center; gap: 8px;
    }
    .quick-btn:hover { background: linear-gradient(135deg, var(--primary), var(--secondary)); box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3); }

    .recent-links { margin-top: 40px; }
    .recent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
    .recent-item {
      background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); border-radius: 10px; padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease;
      display: flex; align-items: center; gap: 12px; cursor: pointer;
    }
    .recent-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
    .recent-icon {
      width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    .recent-icon i { font-size: 1.2rem; color: white; }
    .recent-info h4 { font-size: 0.9rem; margin-bottom: 5px; }
    .recent-info p { font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); }

    footer {
      display: none; width: 100%; padding: 20px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px);
      text-align: center; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .footer-content { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
    .social-links { display: flex; gap: 15px; margin-top: 10px; }
    .social-links a { color: #fff; font-size: 1.2rem; transition: all 0.3s ease; }
    .social-links a:hover { color: var(--accent); transform: translateY(-3px); }

    #backToTop {
      position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px;
      background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff;
      border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem;
      transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); z-index: 99;
      display: none; align-items: center; justify-content: center;
    }
    #backToTop:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); }

    .notification {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      color: #fff; padding: 12px 25px; border-radius: 30px; display: none; z-index: 1000;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); animation: slideUp 0.3s ease;
      display: flex; align-items:center; gap: 8px;
    }
    @keyframes slideUp { from { transform: translateX(-50%) translateY(100px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }

    .modal {
      display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); animation: fadeInModal 0.3s ease;
    }
    @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
    .modal-content {
      background: linear-gradient(145deg, var(--darker), #1a233a); margin: 5% auto; padding: 25px;
      border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; width: 90%; max-width: 700px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: var(--light);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .modal-header h2 { font-size: 1.5rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 10px;}
    .close-btn { color: rgba(255,255,255,0.7); font-size: 1.8rem; font-weight: bold; transition: color 0.3s ease; }
    .close-btn:hover, .close-btn:focus { color: var(--accent); text-decoration: none; cursor: pointer; }
    
    .user-management-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
    .user-management-section { background-color: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
    .user-management-section h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    #permissionsList { max-height: 300px; overflow-y: auto; padding-right: 10px; }
    #permissionsList .permission-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    #permissionsList .permission-item:last-child { border-bottom: none; }
    #permissionsList .permission-item i { margin-right: 8px; color: var(--info); min-width: 16px; text-align: center;}
    #permissionsList .permission-item label { flex-grow: 1; margin-left: 5px; font-size: 0.9rem; cursor:pointer;}
    #permissionsList .permission-item input[type="checkbox"] { transform: scale(1.1); accent-color: var(--primary); cursor:pointer; margin-right: 5px;}
    
    #notepadModal .modal-content { max-width: 600px; }
    #notepadModal .action-btn-group { display: flex; gap: 15px; margin-top: 20px;}
    #notepadModal .action-btn-group .action-btn { width: 100%; }

    #portalSettingsModal .modal-content { max-width: 750px; } /* Wider for custom links */
    .portal-settings-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
    .portal-settings-section { background-color: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
    .portal-settings-section h3 { margin-top: 0; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;}
    .color-picker-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
    .color-picker-group label { flex-basis: 120px; }
    .color-picker-group input[type="color"] { flex-grow: 1; }
    .data-management-buttons .action-btn { margin-top: 10px; }
    #importConfigFileLabel {
        display: block; width: 100%; padding: 12px; background: linear-gradient(135deg, var(--info), var(--cyan));
        color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer;
        transition: all 0.3s ease; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        text-align: center;
    }
    #importConfigFileLabel:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
    #importConfigFile { display: none; }
    
    /* Custom Links Management */
    #customLinksList { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; margin-top:15px; }
    #customLinksList li {
        background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 8px; margin-bottom: 10px;
        display: flex; justify-content: space-between; align-items: center;
        border: 1px solid rgba(255,255,255,0.1);
    }
    #customLinksList li .link-details { display: flex; flex-direction: column; }
    #customLinksList li .link-title { font-weight: 500; }
    #customLinksList li .link-url { font-size: 0.8rem; color: rgba(255,255,255,0.6); word-break: break-all; }
    #customLinksList li .link-actions button {
        background: transparent; border: none; color: rgba(255,255,255,0.7); cursor: pointer;
        padding: 5px; font-size: 0.9rem; transition: color 0.3s ease;
    }
    #customLinksList li .link-actions button:hover { color: var(--accent); }
    #customLinksList li .link-actions button.edit-btn:hover { color: var(--info); }


    @media (min-width: 768px) { 
        .user-management-grid { grid-template-columns: 1fr 1.5fr; } 
        .portal-settings-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    }
    @media (max-width: 1200px) { .dashboard-overview { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); } }
    @media (max-width: 992px) { .button-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); } }
    @media (max-width: 768px) {
      header { flex-direction: column; padding: 15px; gap: 10px; align-items: flex-start;}
      .header-info { flex-direction: column; gap: 8px; align-items: flex-start; margin-top: 10px;}
      .header-buttons { margin-top: 10px; width: 100%; justify-content: flex-start;}
      h1 { font-size: 1.5rem; } .search-bar { width: 100%; }
      .btn { padding: 15px; font-size: 0.85rem; } .btn i:first-child { font-size: 1rem; margin-right: 10px; }
      .dashboard-overview { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 576px) {
      .button-grid { grid-template-columns: 1fr; }
      .popup-content, .modal-content { padding: 20px; margin: 10% auto; }
      .btn { padding: 14px; } .dashboard-overview { grid-template-columns: 1fr; }
      .search-filter-container { flex-direction: column; } 
      .user-management-grid, .portal-settings-grid { grid-template-columns: 1fr; }
      .header-buttons .header-btn { flex-grow: 1; justify-content: center;}
    }
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>

  <header>
    <div class="logo"><i class="fas fa-cubes"></i><h1>RADNIK QUINCE PORTAL</h1></div>
    <div class="header-info">
        <p id="userName"></p>
        <p id="clock"></p>
    </div>
    <div class="header-buttons">
      <button class="header-btn" id="portalSettingsBtn" onclick="openPortalSettingsModal()"><i class="fas fa-cogs"></i> Portal Settings</button>
      <button class="header-btn" id="userManagementBtn" onclick="openUserManagementModal()"><i class="fas fa-users-cog"></i> User Management</button>
      <button class="header-btn" onclick="openNotepadModal()"><i class="fas fa-edit"></i> Notepad</button>
      <button class="header-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </header>

  <div class="popup" id="loginPopup" style="display: flex;">
    <div class="popup-content">
      <h2 class="popup-header"><i class="fas fa-lock"></i> Login</h2>
      <div class="input-group"><label for="username"><i class="fas fa-user"></i> Username</label><input type="text" id="username" placeholder="Enter username"></div>
      <div class="input-group"><label for="password"><i class="fas fa-key"></i> Password</label><input type="password" id="password" placeholder="Enter password"></div>
      <div class="checkbox-group"><input type="checkbox" id="rememberMe"><label for="rememberMe">Remember Me</label></div>
      <button class="login-btn" onclick="validateLogin()"><i class="fas fa-sign-in-alt"></i> Login</button>
      <p class="forgot-password"><a href="#"><i class="fas fa-question-circle"></i> Forgot Password?</a></p>
      <p class="error-message" id="errorMessage"></p>
      <div class="login-footer">
        © 2025 Radnik Exports. Designed by Amit Chaudhary.
      </div>
    </div>
  </div>

  <div id="userManagementModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2><i class="fas fa-users-cog"></i> User Management</h2><span class="close-btn" onclick="closeUserManagementModal()">×</span></div>
      <div id="userManagementMessage" style="margin-bottom:15px; display:none;"></div>
      <div class="user-management-grid">
        <div class="user-management-section">
          <h3><i class="fas fa-user-plus"></i> Create New User</h3>
          <div class="input-group"><label for="newUsername"><i class="fas fa-user-tag"></i> Username</label><input type="text" id="newUsername" placeholder="New username"></div>
          <div class="input-group"><label for="newPassword"><i class="fas fa-asterisk"></i> Password</label><input type="password" id="newPassword" placeholder="New password"></div>
          <button class="action-btn" onclick="handleCreateUser()"><i class="fas fa-plus-circle"></i> Create User</button>
        </div>
        <div class="user-management-section">
          <h3><i class="fas fa-user-edit"></i> Edit User Permissions</h3>
          <div class="input-group">
            <label for="selectUserForPermissions"><i class="fas fa-user-check"></i> Select User</label>
            <select id="selectUserForPermissions" onchange="loadPermissionsForSelectedUser()"><option value="">-- Select User --</option></select>
          </div>
          <div id="permissionsContainer" style="display:none;">
            <h4><i class="fas fa-tasks"></i> Button Access Permissions:</h4><div id="permissionsList"></div>
            <button class="action-btn" onclick="handleSavePermissions()" style="margin-top: 20px;"><i class="fas fa-save"></i> Save Permissions</button>
            <button class="action-btn secondary" onclick="handleDeleteUser()" style="margin-top: 10px;" id="deleteUserBtn" disabled><i class="fas fa-user-times"></i> Delete Selected User</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="editDashboardModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-tachometer-alt-edit"></i> Edit Dashboard Data</h2>
            <span class="close-btn" onclick="closeEditDashboardModal()">×</span>
        </div>
        <div id="editDashboardMessage" style="margin-bottom:15px; display:none;"></div>
        <input type="hidden" id="editingCardId">
        <div class="input-group">
            <label for="cardValueInput"><i class="fas fa-pencil-alt"></i> Value</label>
            <input type="text" id="cardValueInput" placeholder="Enter new value">
        </div>
        <div class="input-group">
            <label for="cardUnitInput"><i class="fas fa-tag"></i> Unit (e.g., cr, pcs)</label>
            <input type="text" id="cardUnitInput" placeholder="Leave blank if no unit">
        </div>
        <button class="action-btn" onclick="handleSaveDashboardData()"><i class="fas fa-save"></i> Save Data</button>
    </div>
  </div>

  <div id="notepadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-sticky-note"></i> My Notepad</h2>
            <span class="close-btn" onclick="closeNotepadModal()">×</span>
        </div>
        <div class="input-group">
            <label for="notepadTextarea"><i class="fas fa-pen-alt"></i> Your Notes</label>
            <textarea id="notepadTextarea" placeholder="Type your notes here... They are saved locally."></textarea>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" onclick="saveNotepadContent()"><i class="fas fa-save"></i> Save Notes</button>
            <button class="action-btn secondary" onclick="closeNotepadModal()"><i class="fas fa-times-circle"></i> Close Notepad</button>
        </div>
    </div>
  </div>

  <div id="portalSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-tools"></i> Portal Settings & Management</h2>
            <span class="close-btn" onclick="closePortalSettingsModal()">×</span>
        </div>
        <div id="portalSettingsMessage" style="margin-bottom:15px; display:none;"></div>
        
        <div class="portal-settings-section">
            <h3><i class="fas fa-link"></i> Manage Custom Links</h3>
            <input type="hidden" id="editingCustomLinkId">
            <div class="input-group">
                <label for="customLinkText"><i class="fas fa-closed-captioning"></i> Link Text</label>
                <input type="text" id="customLinkText" placeholder="e.g., Company Intranet">
            </div>
            <div class="input-group">
                <label for="customLinkUrl"><i class="fas fa-external-link-alt"></i> Link URL</label>
                <input type="url" id="customLinkUrl" placeholder="https://example.com">
            </div>
            <div class="input-group">
                <label for="customLinkIcon"><i class="fab fa-font-awesome-flag"></i> Icon Class (e.g., fas fa-link)</label>
                <input type="text" id="customLinkIcon" placeholder="fas fa-globe">
            </div>
             <div class="input-group">
                <label for="customLinkColorClass"><i class="fas fa-palette"></i> Button Color Class (e.g., btn-1, btn-info)</label>
                <input type="text" id="customLinkColorClass" placeholder="btn-4 (see existing buttons for examples)">
            </div>
            <div class="input-group">
                <label for="customLinkTags"><i class="fas fa-tags"></i> Tags (comma-separated)</label>
                <input type="text" id="customLinkTags" placeholder="tools, internal, reports">
            </div>
            <button class="action-btn" id="addOrUpdateCustomLinkBtn" onclick="handleAddOrUpdateCustomLink()"><i class="fas fa-plus-circle"></i> Add Link</button>
            
            <h4>Existing Custom Links:</h4>
            <ul id="customLinksList"></ul>
        </div>

        <div class="portal-settings-grid" style="margin-top: 25px;">
            <div class="portal-settings-section">
                <h3><i class="fas fa-palette"></i> Theme Customization</h3>
                <div class="color-picker-group">
                    <label for="primaryColorPicker"><i class="fas fa-fill-drip"></i> Primary Color:</label>
                    <input type="color" id="primaryColorPicker">
                </div>
                <div class="color-picker-group">
                    <label for="accentColorPicker"><i class="fas fa-highlighter"></i> Accent Color:</label>
                    <input type="color" id="accentColorPicker">
                </div>
                <button class="action-btn" onclick="saveThemeSettings()"><i class="fas fa-paint-brush"></i> Apply Colors</button>
            </div>

            <div class="portal-settings-section">
                <h3><i class="fas fa-atom"></i> Particle Effects</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="particleToggle">
                    <label for="particleToggle"><i class="fas fa-toggle-on"></i> Enable Particle Background</label>
                </div>
                 <button class="action-btn" onclick="resetDefaultThemeAndParticles()"><i class="fas fa-undo"></i> Reset Visuals</button>
            </div>
        </div>
        <div class="portal-settings-section data-management-buttons" style="margin-top: 25px;">
            <h3><i class="fas fa-database"></i> Data Management</h3>
            <button class="action-btn" onclick="exportPortalConfig()"><i class="fas fa-file-export"></i> Export Configuration</button>
            <label for="importConfigFile" id="importConfigFileLabel"><i class="fas fa-file-import"></i> Import Configuration</label>
            <input type="file" id="importConfigFile" accept=".json" onchange="handleImportConfig(event)">
            <button class="action-btn danger" onclick="clearAllPortalData()"><i class="fas fa-skull-crossbones"></i> Clear All Portal Data</button>
        </div>
    </div>
</div>


  <div class="container">
    <div class="dashboard-overview" id="dashboardOverviewSection">
      <div class="overview-card" data-card-id="ggnSaleQty">
        <h3><i class="fas fa-boxes-stacked"></i> GGN/Total Quince Sale Qty <i class="fas fa-edit edit-card-btn" title="Edit Data"></i></h3>
        <p><span class="card-value">361823</span> <span class="card-unit">pcs</span></p>
        <div class="card-footer"><i class="fas fa-sync-alt"></i> Updated <span class="card-update-time">just now</span></div>
      </div>
      <div class="overview-card" data-card-id="ggnSaleValue">
        <h3><i class="fas fa-rupee-sign"></i> GGN/Total Quince Sale Value <i class="fas fa-edit edit-card-btn" title="Edit Data"></i></h3>
        <p><span class="card-value">54.46</span> <span class="card-unit">cr</span></p>
        <div class="card-footer"><i class="fas fa-sync-alt"></i> Updated <span class="card-update-time">today</span></div>
      </div>
      <div class="overview-card" data-card-id="noidaSaleQty">
        <h3><i class="fas fa-box-open"></i> NOIDA/Total Quince Sale Qty <i class="fas fa-edit edit-card-btn" title="Edit Data"></i></h3>
        <p><span class="card-value">54600</span> <span class="card-unit">pcs</span></p>
        <div class="card-footer"><i class="fas fa-sync-alt"></i> Updated <span class="card-update-time">today</span></div>
      </div>
      <div class="overview-card" data-card-id="noidaSaleValue">
        <h3><i class="fas fa-money-bill-trend-up"></i> NOIDA/Total Quince Sale Value <i class="fas fa-edit edit-card-btn" title="Edit Data"></i></h3>
        <p><span class="card-value">6.40</span> <span class="card-unit">cr</span></p>
        <div class="card-footer"><i class="fas fa-sync-alt"></i> Updated <span class="card-update-time">2 days ago</span></div>
      </div>
    </div>

    <div class="search-filter-container">
      <div class="search-container"><div class="search-bar"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="Search links by name..."></div></div>
      <div class="filter-tags">
        <div class="filter-tag active" data-filter="all">All</div><div class="filter-tag" data-filter="finance">Finance</div>
        <div class="filter-tag" data-filter="sales">Sales</div><div class="filter-tag" data-filter="inventory">Inventory</div>
        <div class="filter-tag" data-filter="reports">Reports</div><div class="filter-tag" data-filter="tools">Tools</div>
        <div class="filter-tag" data-filter="custom">Custom</div> 
      </div>
    </div>

    <div class="quick-access">
      <div class="quick-btn" onclick="filterByTagManual('finance')"><i class="fas fa-file-invoice-dollar"></i> Finance</div>
      <div class="quick-btn" onclick="filterByTagManual('sales')"><i class="fas fa-chart-bar"></i> Sales Data</div>
      <div class="quick-btn" onclick="filterByTagManual('inventory')"><i class="fas fa-boxes"></i> Inventory</div>
      <div class="quick-btn" onclick="filterByTagManual('reports')"><i class="fas fa-file-pdf"></i> Reports</div>
    </div>

    <div class="section-header"><h2><i class="fas fa-link"></i> All Quick Links</h2></div>
    <div class="button-grid" id="buttonContainer">
      <a href="https://docs.google.com/spreadsheets/d/1p1LreGjZFEWSY3qfkbGaWGymDa_3kzwucDH3xHoPzqU/edit?resourcekey=&gid=1066878755#gid=1066878755" class="btn btn-1" target="_blank" data-tags="finance" data-id="noida-tax-invoice"><i class="fas fa-file-invoice-dollar"></i><span class="btn-text">Noida Tax Invoice Log</span><span class="btn-tag">Finance</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1clgoSGc3BF6u25v-cumlJMqrCOZYSydWJ_xSAOpe0FE/edit?gid=82980654#gid=82980654" class="btn btn-2" target="_blank" data-tags="finance" data-id="186-tax-invoice"><i class="fas fa-receipt"></i><span class="btn-text">186 Tax Invoice Log</span><span class="btn-tag">Finance</span></a>
      <a href="https://192.168.20.7/vgeinvoice/LoginPage.aspx" class="btn btn-3" target="_blank" data-tags="finance,tools" data-id="eway-bill"><i class="fas fa-truck-fast"></i><span class="btn-text">E-Way Bill Dashboard</span><span class="btn-tag">Finance</span></a>
      <a href="https://smallpdf.com/merge-pdf#r=organize-merge" class="btn btn-4" target="_blank" data-tags="tools" data-id="merge-pdf"><i class="fas fa-file-pdf"></i><span class="btn-text">Merge PDF</span><span class="btn-tag">Tools</span></a>
      <a href="https://www.office.com/apps/?auth=2" class="btn btn-5" target="_blank" data-tags="tools" data-id="app-365"><i class="fab fa-microsoft"></i><span class="btn-text">Office 365 Apps</span><span class="btn-tag">Tools</span></a>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSfQf5LaxGX8lLr4nN7hPmrL3mpuaFv1uzYMTaIb02IcGFHp5g/viewform" class="btn btn-6" target="_blank" data-tags="finance" data-id="chargeback-form"><i class="fas fa-undo-alt"></i><span class="btn-text">Chargeback Form</span><span class="btn-tag">Finance</span></a>
      <a href="https://radnikexports1-my.sharepoint.com/:x:/r/personal/amit_chaudhary_radnikexports1_onmicrosoft_com/_layouts/15/Doc.aspx?sourcedoc=%7B5DE750E6-1A38-4B42-B02D-44A3D95B2D14%7D&file=Book%206.xlsx&action=editnew&mobileredirect=true" class="btn btn-7" target="_blank" data-tags="sales" data-id="daily-sale-186"><i class="fas fa-calendar-day"></i><span class="btn-text">Daily Sale 186</span><span class="btn-tag">Sales</span></a>
      <a href="https://radnikexports1-my.sharepoint.com/:x:/r/personal/amit_chaudhary_radnikexports1_onmicrosoft_com/_layouts/15/Doc.aspx?sourcedoc=%7B866121D0-C91C-4F09-9F0B-909FBB0C2324%7D&file=DAILY%20SALE%20ENTERY%20NOIDA.xlsx&action=default&mobileredirect=true" class="btn btn-8" target="_blank" data-tags="sales" data-id="dsec16-sale"><i class="fas fa-cash-register"></i><span class="btn-text">D-S-E-C16 (Noida Sale)</span><span class="btn-tag">Sales</span></a>
      <a href="https://docs.google.com/spreadsheets/d/11RCeL6pUqN8khww5sY_iA_t-mNgrzwQNvV-bRtLKA9s/edit?gid=0#gid=0" class="btn btn-9" target="_blank" data-tags="inventory,sales" data-id="noida-order-entry"><i class="fas fa-clipboard-check"></i><span class="btn-text">Noida Order Entry</span><span class="btn-tag">Inventory</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1V92jsBq9iTbYnaoaIdmYdbYc9uoFvaimxaYScnHLD7w/edit?resourcekey=&gid=388707961#gid=388707961" class="btn btn-10" target="_blank" data-tags="finance" data-id="chargeback-data"><i class="fas fa-hand-holding-usd"></i><span class="btn-text">Chargeback Data</span><span class="btn-tag">Finance</span></a>
      <a href="https://docs.google.com/spreadsheets/d/17XLwAmZxvmxOaB-DzPIBjuGmb3u_Zxz9_1aGn175yeE/edit?gid=0#gid=0" class="btn btn-11" target="_blank" data-tags="reports,sales" data-id="live-graph-quince"><i class="fas fa-chart-line"></i><span class="btn-text">Live Graph Quince</span><span class="btn-tag">Reports</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1c4VbDj3CCp_Lr2MCpoJXmlp2K9qP6L3pIA0eZq52PDM/edit?gid=2065470756#gid=2065470756" class="btn btn-12" target="_blank" data-tags="reports,sales" data-id="quince-2024-sale"><i class="fas fa-database"></i><span class="btn-text">QUINCE 2024 SALE DATA</span><span class="btn-tag">Reports</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1sehWq-1kvNwl0qZWOpkhapuk9mam0FjKAoJvHMV9U5o/edit?usp=sharing" class="btn btn-13" target="_blank" data-tags="inventory,operations" data-id="maersk-stock-data"><i class="fas fa-ship"></i><span class="btn-text">MAERSK Stock Data</span><span class="btn-tag">Inventory</span></a>
      <a href="https://docs.google.com/spreadsheets/d/17RWCZ62o2nRvMgZjfi_fZ6AyBQ0YmHNoIp-CCRSxJjg/edit?gid=407320691#gid=407320691" class="btn btn-14" target="_blank" data-tags="sales" data-id="quince-2025-pos"><i class="fas fa-shopping-cart"></i><span class="btn-text">QUINCE 2025 POS DATA</span><span class="btn-tag">Sales</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1PnetSLtEPxot9N3KlB_ydbzNccAF5qMnDMRmYLo6ZLs/edit?gid=0#gid=0" class="btn btn-15" target="_blank" data-tags="sales,finance" data-id="quince-invoice-summary"><i class="fas fa-file-invoice"></i><span class="btn-text">Quince Invoice Summary</span><span class="btn-tag">Sales</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1riS3U9aPW7s8SQmqaZkGrb2fHVEdDbJdHxwdygaeKXc/edit?gid=1345083956#gid=1345083956" class="btn btn-15" target="_blank" data-tags="sales,reports" data-id="ggn-sales-overview"><i class="fas fa-city"></i><span class="btn-text">Gurugram Sales Overview</span><span class="btn-tag">Sales</span></a>
      <a href="https://docs.google.com/spreadsheets/d/15Xma9DRkRectWPqUKDQlr5yZQMtCfQ2Bxa_J5vU-Es0/edit?gid=1345083956#gid=1345083956" class="btn btn-16" target="_blank" data-tags="sales,reports" data-id="noida-sales-overview"><i class="fas fa-building-user"></i><span class="btn-text">Noida Sales Overview</span><span class="btn-tag">Sales</span></a>
      <a href="https://sites.google.com/view/bossanishji/" class="btn btn-17" target="_blank" data-tags="tools" data-id="anish-sir-site"><i class="fas fa-user-tie"></i><span class="btn-text">Anish Sir's Site</span><span class="btn-tag">Tools</span></a>
      <a href="https://sites.google.com/view/radnikaks/home?authuser=0" class="btn btn-18" target="_blank" data-tags="tools" data-id="amit-chaudhary-site"><i class="fas fa-user-astronaut"></i><span class="btn-text">Amit Chaudhary's Site</span><span class="btn-tag">Tools</span></a>
      <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_ihmuGBmPjY_SF6zXQe825cL0i3O9FjTod0gVVgjvc9uSU1HrQsSxcGSVRLAUrJA8NjruJPKs7ezi/pubhtml?gid=1345083956&single=true" class="btn btn-19" target="_blank" data-tags="reports" data-id="186-qs-view"><i class="fas fa-chart-pie"></i><span class="btn-text">186-Q-S-VIEW</span><span class="btn-tag">Reports</span></a>
      <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vT1MRNcqWJsXyp4gKAq00N2qKmjoNgXkwVCmxH2lBeeitlz0kNfSiY-z1sNK2JTciPN6mzUpF9-G36Z/pubhtml?gid=1345083956&single=true" class="btn btn-20" target="_blank" data-tags="reports" data-id="c16-qs-view"><i class="fas fa-chart-area"></i><span class="btn-text">C16-Q-S-VIEW</span><span class="btn-tag">Reports</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1m3q0x9wKoM7Q7EBSCvpCTozbtB0-73xmgOO_Yx0EBAg/edit?gid=579600821#gid=579600821" class="btn btn-21" target="_blank" data-tags="inventory" data-id="c16-import-details"><i class="fas fa-file-import"></i><span class="btn-text">C16-IMPORT DETAILS</span><span class="btn-tag">Inventory</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1LZa3JvfEdt-9cdQkEmsEluwurMoDzmsXIyFWNpAcnfs/edit?gid=1102120828#gid=1102120828" class="btn btn-22" target="_blank" data-tags="inventory" data-id="ggn-prep-2025"><i class="fas fa-tasks-alt"></i><span class="btn-text">GGN-PREPEMENT 2025</span><span class="btn-tag">Inventory</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1l2CnQrl9YEfOFAoiqj82DYwJ-zQWYqCX5HuL87ffRlw/edit?gid=2040776333#gid=2040776333" class="btn btn-23" target="_blank" data-tags="reports,sales" data-id="quince-hk"><i class="fas fa-globe-asia"></i><span class="btn-text">Quince Hong Kong</span><span class="btn-tag">Reports</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1QzAuxxuLUz60iWbdiVGzAFDjXY0RSZIda_0VOhbloEU/edit?gid=1012800260#gid=1012800260" class="btn btn-24" target="_blank" data-tags="reports,sales" data-id="projection-vs-sales"><i class="fas fa-bullseye-arrow"></i><span class="btn-text">Projection VS Sales Report</span><span class="btn-tag">Reports</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1JFI22zsy2Pa5d2lq4dcEeCZIg7rqFaBMYPzniBdlhMc/edit?gid=874524179#gid=874524179" class="btn btn-25" target="_blank" data-tags="reports,inventory" data-id="quince-order-chart"><i class="fas fa-list-ol"></i><span class="btn-text">QUINCE ORDER CHART</span><span class="btn-tag">Reports</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1f7bODkOgwvN_i-nWItzn_67IZv0EqXxAqr2v-ZRQ8Vg/edit?gid=685323596#gid=685323596" class="btn btn-26" target="_blank" data-tags="reports,sales" data-id="projection-vs-actual"><i class="fas fa-project-diagram"></i><span class="btn-text">PROJECTION VS ACTUAL</span><span class="btn-tag">Reports</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1_5-nGWZmyI5WkTSp6muKe7uEhel7DoAzX1oisoBz1Xw/edit?gid=211447390#gid=211447390" class="btn btn-27" target="_blank" data-tags="reports,sales,inventory" data-id="quince-sale-hub"><i class="fas fa-database"></i><span class="btn-text">Quince Sale All Data Hub</span><span class="btn-tag">Data Hub</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1bQqiCaiQ_JGN_B-415ftvVgoH9MmaF9A4ydZkkYXS-Q/edit?gid=5003036#gid=5003036" class="btn btn-28" target="_blank" data-tags="inventory" data-id="po-wise-qty"><i class="fas fa-exchange-alt"></i><span class="btn-text">PO Wise Qty Send/Sale</span><span class="btn-tag">Inventory</span></a>
      <a href="https://amitaadhya.github.io/Quincesaleggn/" class="btn btn-19" target="_blank" data-tags="reports,sales" data-id="sales-perf-ggn"><i class="fas fa-tachometer-alt"></i><span class="btn-text">Sales Perf. Dashboard-GGN</span><span class="btn-tag">Dashboard</span></a>
      <a href="https://amitaadhya.github.io/noidaquincesale/" class="btn btn-20" target="_blank" data-tags="reports,sales" data-id="sales-perf-noida"><i class="fas fa-chart-bar"></i><span class="btn-text">NOIDA-Sales Perf. Dash.</span><span class="btn-tag">Dashboard</span></a>
      <a href="https://docs.google.com/spreadsheets/d/1GQucVQMxZanFgg27PGDpflR49a6DksezH4Pby2uFu4A/edit?gid=0#gid=0" class="btn btn-26" target="_blank" data-tags="reports,finance" data-id="quince-style-value"><i class="fas fa-dollar-sign"></i><span class="btn-text">QUINCE Style Name Wise Value</span><span class="btn-tag">Finance</span></a>
	  <a href="https://docs.google.com/spreadsheets/d/1PnetSLtEPxot9N3KlB_ydbzNccAF5qMnDMRmYLo6ZLs/edit?gid=0#gid=0" class="btn btn-20" target="_blank" data-tags="reports,sales" data-id="sales-perf-noida"><i class="fas fa-chart-bar"></i><span class="btn-text">Quince_Invoice Summary</span><span class="btn-tag">Account</span></a>
	  <a href="https://script.google.com/macros/s/AKfycbwMLk_TuKGtxzLFMxIoLVONqYMS5RRCf3cBqS9zDw/dev" class="btn btn-20" target="_blank" data-tags="reports,sales" data-id="sales-perf-noida"><i class="fas fa-chart-bar"></i><span class="btn-text">Quince_ Style Analyzer_GGN</span><span class="btn-tag">Inventory</span></a>
	  <a href="https://script.google.com/macros/s/AKfycbzljj_8OxdNR2AtJqxfTD_oB11YGTdF0MGulyLCvpE/dev" class="btn btn-20" target="_blank" data-tags="reports,sales" data-id="sales-perf-noida"><i class="fas fa-chart-bar"></i><span class="btn-text">Quince_ Style Analyzer_NOIDA</span><span class="btn-tag">Inventory</span></a>
      <!-- Custom links will be appended here by JavaScript -->
    </div>

    <div class="recent-links" id="recentLinksSection">
      <div class="section-header">
        <h2><i class="fas fa-history"></i> Recently Accessed</h2>
        <button class="action-btn-small" id="clearRecentLinksBtn" onclick="clearRecentLinks()" style="display:none;"><i class="fas fa-trash-alt"></i> Clear All</button>
      </div>
      <div class="recent-grid" id="recentLinksContainer"></div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p>© 2025 Radnik Exports Global Pvt. Ltd. | Designed & Developed by Amit Chaudhary</p>
      <div class="social-links">
        <a href="#" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a><a href="#" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
        <a href="#" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a><a href="#" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a>
      </div>
    </div>
  </footer>

  <button id="backToTop" title="Go to top"><i class="fas fa-arrow-up"></i></button>
  <div id="notification" class="notification"></div>

<script>
    // --- Constants & State Variables ---
    const PORTAL_DATA_VERSION_KEY = 'radnikPortalVersion';
    const CURRENT_PORTAL_VERSION = '1.2.0'; // Custom Links feature
    const USERS_KEY = 'radnikPortalUsers';
    const USER_PERMISSIONS_KEY = 'radnikPortalUserPermissions';
    const GLOBAL_BUTTON_STATES_KEY = 'radnikButtonStates';
    const CUSTOM_LINKS_KEY = 'radnikCustomLinks'; // New key for dynamic links
    const RECENT_LINKS_KEY = 'recentLinks';
    const USER_NOTES_KEY = 'userNotes_v2';
    const DASHBOARD_DATA_KEY = 'radnikDashboardData';
    const THEME_SETTINGS_KEY = 'radnikThemeSettings';
    const PARTICLE_SETTINGS_KEY = 'radnikParticleSettings';
    
    const DASHBOARD_SECTION_ID = 'dashboardOverviewSection';
    const RECENT_LINKS_SECTION_ID = 'recentLinksSection';

    let currentUser = null;
    document.documentElement.style.setProperty('--particle-float-x', (Math.random() > 0.5 ? '1000px' : '-1000px'));

    // --- Core Data Management ---
    function getFromLocalStorage(key, defaultValue = undefined) {
        const itemJson = localStorage.getItem(key);
        try { 
            return itemJson !== null ? JSON.parse(itemJson) : defaultValue; 
        } catch (e) { 
            console.error(`Error parsing localStorage key "${key}":`, e); 
            return defaultValue; 
        }
    }
    function saveToLocalStorage(key, data) {
        try { 
            localStorage.setItem(key, JSON.stringify(data)); 
        } catch (e) { 
            console.error(`Error saving to localStorage key "${key}":`, e); 
        }
    }
    function getUsers() { return getFromLocalStorage(USERS_KEY, []); }
    function saveUsers(users) { saveToLocalStorage(USERS_KEY, users); }
    function getUserPermissions() { return getFromLocalStorage(USER_PERMISSIONS_KEY, {}); }
    function saveUserPermissions(permissions) { saveToLocalStorage(USER_PERMISSIONS_KEY, permissions); }
    function getGlobalButtonStates() { return getFromLocalStorage(GLOBAL_BUTTON_STATES_KEY, {}); }
    function saveGlobalButtonState(buttonId, isGloballyDisabled) {
        const states = getGlobalButtonStates();
        if (isGloballyDisabled) states[buttonId] = true;
        else delete states[buttonId];
        saveToLocalStorage(GLOBAL_BUTTON_STATES_KEY, states);
    }
    function getCustomLinks() { return getFromLocalStorage(CUSTOM_LINKS_KEY, []); }
    function saveCustomLinks(links) { saveToLocalStorage(CUSTOM_LINKS_KEY, links); }

    function simpleHash(password) {
        if (typeof password !== 'string') return '';
        let hash = 0;
        for (let i = 0; i < password.length; i++) {
            const char = password.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; 
        }
        return "hashed_" + (hash * 0xDEADBEEF).toString(16) + "_salted_v3";
    }

    function initializeDefaultAdmin() {
        let users = getUsers();
        const adminUsername = 'admin'; const amitUsername = 'amit';
        const adminPasswordHash = simpleHash('aminehu@123'); const amitPasswordHash = simpleHash('aminehu@123');
        let adminUser = users.find(u => u.username === adminUsername);
        let amitUser = users.find(u => u.username === amitUsername);
        let updated = false;

        if (!adminUser) {
            users.push({ username: adminUsername, password: adminPasswordHash });
            updated = true;
        } else if (adminUser.password !== adminPasswordHash) {
            adminUser.password = adminPasswordHash; 
            updated = true;
        }
        if (!amitUser) {
            users.push({ username: amitUsername, password: amitPasswordHash });
            updated = true;
        } else if (amitUser.password !== amitPasswordHash) {
            amitUser.password = amitPasswordHash; 
            updated = true;
        }
        if (updated) saveUsers(users);
    }

    // --- UI Helper Functions ---
    function showGeneralMessage(elementId, message, type = 'success') {
        const el = document.getElementById(elementId);
        if(!el) return;
        let iconClass = 'fas fa-check-circle';
        let messageClass = 'success-message';

        if (type === 'error') {
            iconClass = 'fas fa-exclamation-triangle';
            messageClass = 'error-message';
        } else if (type === 'warning') {
            iconClass = 'fas fa-exclamation-circle';
            messageClass = 'warning-message';
        }
        
        el.innerHTML = `<i class="${iconClass}"></i> ${message}`;
        el.className = messageClass; 
        el.style.display = 'flex';
        if (type !== 'warning') { 
          setTimeout(() => { el.style.display = 'none'; }, 3000);
        }
    }
    function showNotification(message, isError = false, iconClass = null) {
        const el = document.getElementById('notification');
        if (!el) return;
        const icon = iconClass || (isError ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle');
        el.innerHTML = `<i class="${icon}"></i> ${message}`;
        el.style.background = isError ? 'linear-gradient(135deg, var(--accent), #c51162)' : 'linear-gradient(135deg, var(--primary), var(--secondary))';
        el.style.display = 'flex';
        setTimeout(() => { el.style.display = 'none'; }, 3000);
    }
    function clearMessage(elementId) {
        const el = document.getElementById(elementId);
        if(el) el.style.display = 'none';
    }
    function isUserAdmin() { return currentUser && currentUser.username.toLowerCase() === 'admin'; }

    // --- Authentication & Session ---
    function validateLogin() {
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessageEl = document.getElementById('errorMessage');
        const loginPopup = document.getElementById('loginPopup');
        const userNameEl = document.getElementById('userName');
        
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        if (errorMessageEl) errorMessageEl.style.display = 'none';

        if (!username || !password) {
            if (errorMessageEl) {
                errorMessageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Username & Password required.';
                errorMessageEl.style.display = 'flex';
                setTimeout(() => { if (errorMessageEl) errorMessageEl.style.display = 'none'; }, 3000);
            } else showNotification("Username and Password required.", true);
            return;
        }

        const users = getUsers();
        const passwordHashToCompare = simpleHash(password);
        const foundUser = users.find(user => user.username.toLowerCase() === username.toLowerCase() && user.password === passwordHashToCompare);

        if (foundUser) {
            currentUser = foundUser;
            if (loginPopup) loginPopup.style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            document.querySelector('footer').style.display = 'block';
            
            if (isUserAdmin()) {
                userNameEl.innerHTML = `<i class="fas fa-crown"></i> Admin: <span class="username-text">${currentUser.username}</span>`;
                userNameEl.classList.add('admin-user');
            } else {
                userNameEl.innerHTML = `<i class="fas fa-user-circle"></i> User: <span class="username-text">${currentUser.username}</span>`;
                userNameEl.classList.remove('admin-user');
            }
            
            document.body.classList.toggle('admin-mode', isUserAdmin());
            document.getElementById('userManagementBtn').style.display = isUserAdmin() ? 'flex' : 'none';
            document.getElementById('portalSettingsBtn').style.display = isUserAdmin() ? 'flex' : 'none';
            
            if (isUserAdmin()) {
                setupGlobalButtonManagement();
                loadDashboardData();
                renderCustomLinksList(); // For Portal Settings modal
                document.getElementById('clearRecentLinksBtn').style.display = 'inline-flex';
                loadThemeSettings(); 
                loadParticleSetting();
            } else {
                document.querySelectorAll('.admin-toggle').forEach(toggle => toggle.remove());
                document.getElementById('clearRecentLinksBtn').style.display = 'none';
            }
            
            renderAllButtons(); // Renders hardcoded + custom links
            applySectionVisibility(); 
            // applyButtonVisibility(); // Called within renderAllButtons now
            showNotification(`Login successful! Welcome, ${currentUser.username}.`);
            usernameInput.value = ''; passwordInput.value = '';
        } else {
            if (errorMessageEl) {
                errorMessageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Invalid username or password.';
                errorMessageEl.style.display = 'flex';
                setTimeout(() => { if (errorMessageEl) errorMessageEl.style.display = 'none'; }, 3000);
            } else showNotification("Invalid username or password.", true);
        }
    }

    function logout() {
        currentUser = null;
        document.querySelector('.container').style.display = 'none';
        document.querySelector('footer').style.display = 'none';
        document.getElementById('loginPopup').style.display = 'flex';
        const userNameEl = document.getElementById('userName');
        userNameEl.textContent = '';
        userNameEl.classList.remove('admin-user');
        document.body.classList.remove('admin-mode');
        document.getElementById('userManagementBtn').style.display = 'none';
        document.getElementById('portalSettingsBtn').style.display = 'none';
        document.querySelectorAll('.admin-toggle').forEach(toggle => toggle.remove());
        document.getElementById('clearRecentLinksBtn').style.display = 'none';
        
        renderAllButtons(); // Show only globally available for logged-out
        applySectionVisibility(); 
        // loadGlobalButtonStatesForLoggedOutView(); // Covered by renderAllButtons
        showNotification('You have been logged out.');
    }
    
    // --- Section Visibility Control ---
    function applySectionVisibility() {
        const dashboardSection = document.getElementById(DASHBOARD_SECTION_ID);
        const recentLinksSection = document.getElementById(RECENT_LINKS_SECTION_ID);
        const showAdminSections = isUserAdmin();

        if (dashboardSection) dashboardSection.style.display = showAdminSections ? 'grid' : 'none';
        // else console.warn(`Element ID "${DASHBOARD_SECTION_ID}" not found.`);

        if (recentLinksSection) {
            recentLinksSection.style.display = showAdminSections ? 'block' : 'none';
            if(showAdminSections) initializeRecentLinks(); 
            else { 
                const recentLinksContainer = document.getElementById('recentLinksContainer');
                if(recentLinksContainer) recentLinksContainer.innerHTML = '';
            }
        } 
        // else console.warn(`Element ID "${RECENT_LINKS_SECTION_ID}" not found.`);
    }

    // --- Button Rendering, Visibility & Access Control ---
    function generateButtonId(text) {
        return `btn-custom-${text.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').substring(0,20)}-${Date.now().toString().slice(-5)}`;
    }

    function renderAllButtons() {
        const buttonContainer = document.getElementById('buttonContainer');
        // Clear only custom buttons, keep hardcoded ones.
        buttonContainer.querySelectorAll('.custom-btn-removable').forEach(btn => btn.remove());

        const customLinks = getCustomLinks();
        customLinks.forEach(link => {
            const buttonEl = document.createElement('a');
            buttonEl.href = link.url;
            buttonEl.className = `btn ${link.colorClass || 'btn-4'} custom-btn-removable`; // Add removable class
            buttonEl.target = '_blank';
            buttonEl.dataset.tags = link.tags + ",custom"; // Add 'custom' tag
            buttonEl.dataset.id = link.id; // Use stored ID

            buttonEl.innerHTML = `
                <i class="${link.iconClass || 'fas fa-external-link-alt'}"></i>
                <span class="btn-text">${link.text}</span>
                <span class="btn-tag">${link.tags.split(',')[0].trim() || 'Custom'}</span>
            `;
            buttonContainer.appendChild(buttonEl);
        });
        
        assignButtonIdsAndTextWrappers(); // Ensure all buttons have IDs (mainly for hardcoded ones if not set)
        
        if(isUserAdmin()){
            setupGlobalButtonManagement(); // Add admin toggles to ALL buttons
        } else {
            document.querySelectorAll('.admin-toggle').forEach(toggle => toggle.remove());
        }
        applyButtonVisibility(); // Apply visibility based on user, global state, search, tags
        setupRecentLinkTracking(); // Re-attach listeners to all buttons including new custom ones
    }


    function assignButtonIdsAndTextWrappers() {
        document.querySelectorAll('#buttonContainer .btn').forEach((button, index) => {
            if (!button.dataset.id) { // Only assign if not already set (e.g. for hardcoded ones)
                const textSpan = button.querySelector('.btn-text');
                const safeText = textSpan ? textSpan.textContent.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-') : `link-${index}`;
                button.dataset.id = `btn-hc-${safeText.substring(0,25)}`; // hc for hardcoded
            }
            // Ensure .btn-text wrapper
            if (!button.querySelector('.btn-text')) {
                const icon = button.querySelector('i:first-child');
                const tag = button.querySelector('.btn-tag');
                let textContent = '';
                const childNodes = Array.from(button.childNodes);
                childNodes.forEach(node => {
                    if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                        textContent += node.textContent.trim() + ' ';
                        button.removeChild(node);
                    }
                });
                if (textContent.trim()) {
                    const span = document.createElement('span');
                    span.className = 'btn-text';
                    span.textContent = textContent.trim();
                    if (icon && icon.nextSibling) button.insertBefore(span, icon.nextSibling);
                    else if (icon) button.appendChild(span);
                    else if (tag) button.insertBefore(span,tag);
                    else button.prepend(span);
                }
            }
        });
    }
    
    function addAdminGlobalToggles() {
        const globalStates = getGlobalButtonStates();
        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            const buttonId = button.dataset.id;
            if (!buttonId || button.querySelector('.admin-toggle')) return;

            const isGloballyDisabled = globalStates[buttonId] === true;
            const toggle = document.createElement('span');
            toggle.className = 'admin-toggle';
            toggle.innerHTML = `<i class="fas ${isGloballyDisabled ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>`;
            toggle.title = "Toggle global link availability";
            
            const btnTag = button.querySelector('.btn-tag');
            if(btnTag) button.insertBefore(toggle, btnTag); else button.appendChild(toggle);

            toggle.addEventListener('click', (event) => {
                event.preventDefault(); event.stopPropagation();
                const currentGlobalState = getGlobalButtonStates()[buttonId] === true;
                saveGlobalButtonState(buttonId, !currentGlobalState);
                applyButtonVisibility(); 
                showNotification(`Link "${button.querySelector('.btn-text').textContent}" global state ${!currentGlobalState ? 'DISABLED' : 'ENABLED'}.`, !currentGlobalState);
            });
        });
    }
    
    function loadGlobalButtonStatesForLoggedOutView() { // This is part of applyButtonVisibility now
        applyButtonVisibility();
    }

    function setupGlobalButtonManagement() { addAdminGlobalToggles(); /* loadGlobalButtonStatesForAdminView is part of applyButtonVisibility */ }

    function applyButtonVisibility() { // This now handles all visibility logic
        const globalStates = getGlobalButtonStates();
        const allUserPerms = getUserPermissions();
        const userPermittedIds = (currentUser && allUserPerms[currentUser.username]) ? allUserPerms[currentUser.username] : [];

        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            const buttonId = button.dataset.id;
            if (!buttonId) { // Should not happen after assignButtonIds
                console.warn("Button without data-id found:", button);
                return;
            }
            
            button.classList.remove('globally-disabled-admin-view'); // Reset admin view class
            button.style.display = 'flex'; // Default to visible before checks

            const isGloballyDisabled = globalStates[buttonId] === true;

            if (isUserAdmin()) {
                button.classList.toggle('globally-disabled-admin-view', isGloballyDisabled);
                const toggleIcon = button.querySelector('.admin-toggle i');
                if (toggleIcon) toggleIcon.className = `fas ${isGloballyDisabled ? 'fa-toggle-on' : 'fa-toggle-off'}`;
            } else { // Non-admin or logged-out user
                if (isGloballyDisabled || (currentUser && !userPermittedIds.includes(buttonId))) {
                    button.style.display = 'none';
                }
            }
        });
        filterBySearchAndTag(); // Apply search/tag filters on top of permission/global state
    }


    // --- User Management Modal ---
    function openUserManagementModal() { 
        const modal = document.getElementById('userManagementModal');
        if (modal) {
            modal.style.display = 'block';
            populateUsersDropdown();
            document.getElementById('permissionsContainer').style.display = 'none';
            document.getElementById('deleteUserBtn').disabled = true;
            clearMessage('userManagementMessage');
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
        }
    }
    function closeUserManagementModal() { document.getElementById('userManagementModal').style.display = 'none'; }

    function handleCreateUser() { 
        const newUsernameInput = document.getElementById('newUsername');
        const newPasswordInput = document.getElementById('newPassword');
        const newUsername = newUsernameInput.value.trim();
        const newPassword = newPasswordInput.value.trim();

        if (!newUsername || !newPassword) { showGeneralMessage('userManagementMessage', 'Username and password required.', 'error'); return; }
        if (newUsername.toLowerCase() === 'admin') { showGeneralMessage('userManagementMessage', 'Cannot create user "admin".', 'error'); return; }

        let users = getUsers();
        if (users.some(u => u.username.toLowerCase() === newUsername.toLowerCase())) { showGeneralMessage('userManagementMessage', `User "${newUsername}" already exists.`, 'error'); return; }

        users.push({ username: newUsername, password: simpleHash(newPassword) });
        saveUsers(users);
        showGeneralMessage('userManagementMessage', `User "${newUsername}" created successfully.`, 'success');
        newUsernameInput.value = ''; newPasswordInput.value = '';
        populateUsersDropdown();
    }
    function populateUsersDropdown() { 
        const selectUserEl = document.getElementById('selectUserForPermissions');
        if (!selectUserEl) return;
        const users = getUsers().filter(u => u.username.toLowerCase() !== 'admin');
        const currentVal = selectUserEl.value;
        selectUserEl.innerHTML = '<option value="">-- Select User --</option>';
        users.sort((a,b) => a.username.localeCompare(b.username)).forEach(user => {
            const option = document.createElement('option');
            option.value = user.username; option.textContent = user.username;
            selectUserEl.appendChild(option);
        });
        if (users.find(u=>u.username === currentVal)) {
             selectUserEl.value = currentVal;
        } else {
             document.getElementById('permissionsContainer').style.display = 'none';
             document.getElementById('deleteUserBtn').disabled = true;
        }
    }
    function loadPermissionsForSelectedUser() { 
        const selectedUsername = document.getElementById('selectUserForPermissions').value;
        const permissionsContainer = document.getElementById('permissionsContainer');
        const permissionsListDiv = document.getElementById('permissionsList');
        const deleteBtn = document.getElementById('deleteUserBtn');
        clearMessage('userManagementMessage');

        if (!selectedUsername) {
            permissionsContainer.style.display = 'none';
            deleteBtn.disabled = true;
            return;
        }
        deleteBtn.disabled = false;
        permissionsContainer.style.display = 'block';
        permissionsListDiv.innerHTML = '';

        const allUserPerms = getUserPermissions();
        const userSpecificPerms = allUserPerms[selectedUsername] || [];
        // Populate with ALL buttons, including custom ones
        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            const buttonId = button.dataset.id;
            const btnTextSpan = button.querySelector('.btn-text');
            const buttonText = btnTextSpan ? btnTextSpan.textContent.trim() : `Button (ID: ${buttonId})`;
            if (!buttonId) return;

            const itemDiv = document.createElement('div'); itemDiv.className = 'permission-item';
            const checkbox = document.createElement('input'); checkbox.type = 'checkbox';
            checkbox.id = `perm-${buttonId}-${selectedUsername}`; checkbox.value = buttonId;
            checkbox.checked = userSpecificPerms.includes(buttonId);
            const label = document.createElement('label'); label.htmlFor = checkbox.id; label.textContent = buttonText;
            
            const icon = button.querySelector('i:first-child');
            if(icon) { const iClone = icon.cloneNode(true); itemDiv.appendChild(iClone); }
            
            itemDiv.appendChild(checkbox); itemDiv.appendChild(label);
            permissionsListDiv.appendChild(itemDiv);
        });
    }
    function handleSavePermissions() { 
        const selectedUsername = document.getElementById('selectUserForPermissions').value;
        if (!selectedUsername) { showGeneralMessage('userManagementMessage', 'Select a user first.', 'error'); return; }

        const allowedButtonIds = Array.from(document.querySelectorAll('#permissionsList input[type="checkbox"]:checked')).map(cb => cb.value);
        let allUserPerms = getUserPermissions();
        allUserPerms[selectedUsername] = allowedButtonIds;
        saveUserPermissions(allUserPerms);
        showGeneralMessage('userManagementMessage', `Permissions saved for ${selectedUsername}.`, 'success');
        if (currentUser && currentUser.username === selectedUsername) renderAllButtons(); // Re-render to apply new permissions
    }
    function handleDeleteUser() { 
        const selectedUsername = document.getElementById('selectUserForPermissions').value;
        if (!selectedUsername || selectedUsername.toLowerCase() === 'admin') { showGeneralMessage('userManagementMessage','Select a valid user to delete.', 'error'); return; }
        if (!confirm(`Are you sure you want to delete user "${selectedUsername}"? This action cannot be undone.`)) return;

        let users = getUsers();
        saveUsers(users.filter(u => u.username !== selectedUsername));
        let permissions = getUserPermissions();
        delete permissions[selectedUsername];
        saveUserPermissions(permissions);

        showGeneralMessage('userManagementMessage', `User "${selectedUsername}" deleted successfully.`, 'success');
        populateUsersDropdown();
    }
    
    // --- Dashboard Data Management (Admin Only) ---
    const defaultDashboardData = {
        ggnSaleQty: { value: "361,823", unit: "pcs", updated: new Date().toISOString() },
        ggnSaleValue: { value: "54.46", unit: "Cr", updated: new Date().toISOString() },
        noidaSaleQty: { value: "54,600", unit: "pcs", updated: new Date().toISOString() },
        noidaSaleValue: { value: "6.40", unit: "Cr", updated: new Date().toISOString() }
    };

    function loadDashboardData() {
        if (!isUserAdmin()) return;
        const data = getFromLocalStorage(DASHBOARD_DATA_KEY, defaultDashboardData);
        const mergedData = {...defaultDashboardData, ...data};

        Object.keys(mergedData).forEach(cardId => {
            const cardElement = document.querySelector(`.overview-card[data-card-id="${cardId}"]`);
            if (cardElement) {
                const valueEl = cardElement.querySelector('.card-value');
                const unitEl = cardElement.querySelector('.card-unit');
                const updateTimeEl = cardElement.querySelector('.card-update-time');
                if (valueEl) valueEl.textContent = mergedData[cardId].value;
                if (unitEl) unitEl.textContent = mergedData[cardId].unit || "";
                if (updateTimeEl) updateTimeEl.textContent = formatTime(mergedData[cardId].updated);
            }
        });
        if (JSON.stringify(data) !== JSON.stringify(mergedData)) {
            saveToLocalStorage(DASHBOARD_DATA_KEY, mergedData);
        }
    }

    function openEditDashboardModal(cardId) {
        if (!isUserAdmin()) return;
        clearMessage('editDashboardMessage'); 
        const data = getFromLocalStorage(DASHBOARD_DATA_KEY, defaultDashboardData);
        const cardData = data[cardId];
        if (!cardData) {
            showGeneralMessage('editDashboardMessage', `Data for card ID "${cardId}" not found.`, 'error');
            return;
        }
        document.getElementById('editingCardId').value = cardId;
        document.getElementById('cardValueInput').value = cardData.value;
        document.getElementById('cardUnitInput').value = cardData.unit || "";
        document.getElementById('editDashboardModal').style.display = 'block';
        document.getElementById('cardValueInput').focus();
    }
    function closeEditDashboardModal() {
        document.getElementById('editDashboardModal').style.display = 'none';
    }
    function handleSaveDashboardData() {
        if (!isUserAdmin()) return;
        const cardId = document.getElementById('editingCardId').value;
        const newValue = document.getElementById('cardValueInput').value.trim();
        const newUnit = document.getElementById('cardUnitInput').value.trim();

        if (!newValue) {
            showGeneralMessage('editDashboardMessage', 'Value cannot be empty.', 'error');
            return;
        }

        let data = getFromLocalStorage(DASHBOARD_DATA_KEY, defaultDashboardData);
        if (data[cardId]) {
            data[cardId].value = newValue;
            data[cardId].unit = newUnit;
            data[cardId].updated = new Date().toISOString();
            saveToLocalStorage(DASHBOARD_DATA_KEY, data);
            loadDashboardData(); 
            showGeneralMessage('editDashboardMessage', 'Dashboard data updated successfully!', 'success');
            setTimeout(closeEditDashboardModal, 1500); 
        } else {
            showGeneralMessage('editDashboardMessage', 'Error: Card ID not found.', 'error');
        }
    }


    // --- Portal Settings Modal ---
    function openPortalSettingsModal() {
        if (!isUserAdmin()) return;
        clearMessage('portalSettingsMessage');
        document.getElementById('primaryColorPicker').value = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        document.getElementById('accentColorPicker').value = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        document.getElementById('particleToggle').checked = !document.getElementById('particles').classList.contains('hidden');
        renderCustomLinksList();
        resetCustomLinkForm();
        document.getElementById('portalSettingsModal').style.display = 'block';
    }
    function closePortalSettingsModal() {
        document.getElementById('portalSettingsModal').style.display = 'none';
    }

    function loadThemeSettings() {
        const settings = getFromLocalStorage(THEME_SETTINGS_KEY, {});
        const rootStyle = document.documentElement.style;
        // Set default values if not found in local storage
        const defaultPrimary = '#6a11cb';
        const defaultAccent = '#f43f5e';

        rootStyle.setProperty('--primary', settings.primary || defaultPrimary);
        rootStyle.setProperty('--accent', settings.accent || defaultAccent);
        
        // Update color pickers if modal is open/available
        const primaryPicker = document.getElementById('primaryColorPicker');
        const accentPicker = document.getElementById('accentColorPicker');
        if (primaryPicker) primaryPicker.value = settings.primary || defaultPrimary;
        if (accentPicker) accentPicker.value = settings.accent || defaultAccent;
    }
    function saveThemeSettings() {
        if (!isUserAdmin()) return;
        const primaryColor = document.getElementById('primaryColorPicker').value;
        const accentColor = document.getElementById('accentColorPicker').value;
        document.documentElement.style.setProperty('--primary', primaryColor);
        document.documentElement.style.setProperty('--accent', accentColor);
        saveToLocalStorage(THEME_SETTINGS_KEY, { primary: primaryColor, accent: accentColor });
        showGeneralMessage('portalSettingsMessage', 'Theme colors updated!', 'success');
    }
     function resetDefaultThemeAndParticles() {
        if (!isUserAdmin()) return;
        if (!confirm("Are you sure you want to reset theme colors and particle settings to default?")) return;

        localStorage.removeItem(THEME_SETTINGS_KEY);
        localStorage.removeItem(PARTICLE_SETTINGS_KEY);
        
        loadThemeSettings(); // Reloads and applies defaults
        loadParticleSetting(); // Reloads and applies defaults
        
        // Update color pickers in modal to reflect defaults
        document.getElementById('primaryColorPicker').value = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        document.getElementById('accentColorPicker').value = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        document.getElementById('particleToggle').checked = !document.getElementById('particles').classList.contains('hidden');

        showGeneralMessage('portalSettingsMessage', 'Visuals reset to default.', 'success');
    }


    function loadParticleSetting() {
        const enabled = getFromLocalStorage(PARTICLE_SETTINGS_KEY, true);
        const particleDiv = document.getElementById('particles');
        if (particleDiv) {
            particleDiv.classList.toggle('hidden', !enabled);
            if(enabled && particleDiv.innerHTML === '') createParticles();
            else if (!enabled) particleDiv.innerHTML = '';
        }
    }
    function toggleParticles() {
        if (!isUserAdmin()) return;
        const enabled = document.getElementById('particleToggle').checked;
        saveToLocalStorage(PARTICLE_SETTINGS_KEY, enabled);
        loadParticleSetting();
        showGeneralMessage('portalSettingsMessage', `Particles ${enabled ? 'enabled' : 'disabled'}.`, 'success');
    }

    // --- Custom Links Management ---
    function renderCustomLinksList() {
        if (!isUserAdmin()) return;
        const listEl = document.getElementById('customLinksList');
        listEl.innerHTML = '';
        const links = getCustomLinks();
        if (links.length === 0) {
            listEl.innerHTML = '<li><span class="link-details">No custom links defined yet.</span></li>';
            return;
        }
        links.forEach(link => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="link-details">
                    <span class="link-title"><i class="${link.iconClass || 'fas fa-link'}"></i> ${link.text}</span>
                    <span class="link-url">${link.url}</span>
                </div>
                <div class="link-actions">
                    <button class="edit-btn" onclick="editCustomLink('${link.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteCustomLink('${link.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
            `;
            listEl.appendChild(li);
        });
    }

    function resetCustomLinkForm() {
        document.getElementById('editingCustomLinkId').value = '';
        document.getElementById('customLinkText').value = '';
        document.getElementById('customLinkUrl').value = '';
        document.getElementById('customLinkIcon').value = 'fas fa-link';
        document.getElementById('customLinkColorClass').value = 'btn-info'; // A neutral default
        document.getElementById('customLinkTags').value = '';
        document.getElementById('addOrUpdateCustomLinkBtn').innerHTML = '<i class="fas fa-plus-circle"></i> Add Link';
    }

    function handleAddOrUpdateCustomLink() {
        if (!isUserAdmin()) return;
        const id = document.getElementById('editingCustomLinkId').value;
        const text = document.getElementById('customLinkText').value.trim();
        const url = document.getElementById('customLinkUrl').value.trim();
        const iconClass = document.getElementById('customLinkIcon').value.trim() || 'fas fa-link';
        const colorClass = document.getElementById('customLinkColorClass').value.trim() || 'btn-info';
        const tags = document.getElementById('customLinkTags').value.trim();

        if (!text || !url) {
            showGeneralMessage('portalSettingsMessage', 'Link Text and URL are required.', 'error');
            return;
        }
        try { new URL(url); } catch (_) {
            showGeneralMessage('portalSettingsMessage', 'Invalid URL format.', 'error');
            return;
        }

        let links = getCustomLinks();
        if (id) { // Editing existing
            const linkIndex = links.findIndex(l => l.id === id);
            if (linkIndex > -1) {
                links[linkIndex] = { ...links[linkIndex], text, url, iconClass, colorClass, tags };
            }
        } else { // Adding new
            links.push({ id: generateButtonId(text), text, url, iconClass, colorClass, tags });
        }
        saveCustomLinks(links);
        renderCustomLinksList();
        resetCustomLinkForm();
        renderAllButtons(); // Re-render main button grid
        showGeneralMessage('portalSettingsMessage', `Custom link ${id ? 'updated' : 'added'} successfully.`, 'success');
    }

    function editCustomLink(id) {
        if (!isUserAdmin()) return;
        const links = getCustomLinks();
        const link = links.find(l => l.id === id);
        if (link) {
            document.getElementById('editingCustomLinkId').value = link.id;
            document.getElementById('customLinkText').value = link.text;
            document.getElementById('customLinkUrl').value = link.url;
            document.getElementById('customLinkIcon').value = link.iconClass;
            document.getElementById('customLinkColorClass').value = link.colorClass;
            document.getElementById('customLinkTags').value = link.tags;
            document.getElementById('addOrUpdateCustomLinkBtn').innerHTML = '<i class="fas fa-save"></i> Update Link';
            document.getElementById('customLinkText').focus();
        }
    }

    function deleteCustomLink(id) {
        if (!isUserAdmin()) return;
        if (!confirm('Are you sure you want to delete this custom link?')) return;
        let links = getCustomLinks();
        links = links.filter(l => l.id !== id);
        saveCustomLinks(links);
        renderCustomLinksList();
        renderAllButtons(); // Re-render main button grid
        resetCustomLinkForm(); // If the deleted one was being edited
        showGeneralMessage('portalSettingsMessage', 'Custom link deleted.', 'success');
    }


    function exportPortalConfig() {
        if (!isUserAdmin()) return;
        const config = {
            version: CURRENT_PORTAL_VERSION,
            users: getUsers(),
            permissions: getUserPermissions(),
            globalButtonStates: getGlobalButtonStates(),
            customLinks: getCustomLinks(), // Include custom links
            dashboardData: getFromLocalStorage(DASHBOARD_DATA_KEY, defaultDashboardData),
            themeSettings: getFromLocalStorage(THEME_SETTINGS_KEY, {}),
            particleSettings: getFromLocalStorage(PARTICLE_SETTINGS_KEY, true)
        };
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().slice(0,19).replace(/[-:T]/g,"");
        a.download = `radnik_portal_config_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showGeneralMessage('portalSettingsMessage', 'Configuration exported.', 'success');
    }

    function handleImportConfig(event) {
        if (!isUserAdmin()) return;
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm("Importing this configuration will overwrite all current portal settings. Are you sure?")) {
            event.target.value = null; 
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const config = JSON.parse(e.target.result);
                if (!config.version || typeof config.users === 'undefined' || typeof config.permissions === 'undefined') {
                    throw new Error("Invalid or incomplete configuration file.");
                }
                
                saveUsers(config.users || []);
                saveUserPermissions(config.permissions || {});
                saveToLocalStorage(GLOBAL_BUTTON_STATES_KEY, config.globalButtonStates || {});
                saveCustomLinks(config.customLinks || []); // Import custom links
                saveToLocalStorage(DASHBOARD_DATA_KEY, config.dashboardData || defaultDashboardData);
                saveToLocalStorage(THEME_SETTINGS_KEY, config.themeSettings || {});
                saveToLocalStorage(PARTICLE_SETTINGS_KEY, typeof config.particleSettings !== 'undefined' ? config.particleSettings : true);
                
                showGeneralMessage('portalSettingsMessage', 'Configuration imported successfully! The page will now reload.', 'success');
                setTimeout(() => window.location.reload(), 2000);

            } catch (error) {
                console.error("Error importing configuration:", error);
                showGeneralMessage('portalSettingsMessage', `Import failed: ${error.message}`, 'error');
            } finally {
                event.target.value = null; 
            }
        };
        reader.readAsText(file);
    }

    function clearAllPortalData() {
        if (!isUserAdmin()) return;
        if (!confirm("DANGER: This will delete ALL portal data from your browser's local storage. This action cannot be undone. Are you absolutely sure?")) return;
        if (!confirm("SECOND CONFIRMATION: Are you 100% sure you want to erase everything?")) return;

        const keysToClear = [
            PORTAL_DATA_VERSION_KEY, USERS_KEY, USER_PERMISSIONS_KEY, GLOBAL_BUTTON_STATES_KEY,
            CUSTOM_LINKS_KEY, RECENT_LINKS_KEY, USER_NOTES_KEY, DASHBOARD_DATA_KEY, 
            THEME_SETTINGS_KEY, PARTICLE_SETTINGS_KEY
        ];
        keysToClear.forEach(key => localStorage.removeItem(key));
        
        showGeneralMessage('portalSettingsMessage', 'All portal data cleared. Logging out...', 'warning');
        setTimeout(() => {
            currentUser = null;
            window.location.reload();
        }, 2500);
    }


    // --- Feature Functions (Notepad, Particles, etc.) ---
    function createParticles() { 
        const container = document.getElementById('particles');
        if (!container || container.classList.contains('hidden')) return;
        container.innerHTML = ''; 
        const count = Math.floor(window.innerWidth / 30); 
        for (let i = 0; i < count; i++) {
            const p = document.createElement('div'); p.classList.add('particle');
            const size = Math.random() * 3 + 0.5; 
            p.style.width = `${size}px`; p.style.height = `${size}px`;
            p.style.left = `${Math.random() * window.innerWidth}px`;
            p.style.top = `${Math.random() * (window.innerHeight + 400)}px`;
            p.style.opacity = Math.random() * 0.4 + 0.1; 
            p.style.animationDuration = `${Math.random() * 20 + 15}s`; 
            p.style.animationDelay = `${Math.random() * 20}s`;
            container.appendChild(p);
        }
    }

    function openNotepadModal() {
        const modal = document.getElementById('notepadModal');
        if (modal) {
            modal.style.display = 'block';
            const textarea = document.getElementById('notepadTextarea');
            textarea.value = getFromLocalStorage(USER_NOTES_KEY, '');
            textarea.focus();
        }
    }
    function closeNotepadModal() {
        document.getElementById('notepadModal').style.display = 'none';
    }
    function saveNotepadContent() {
        const textarea = document.getElementById('notepadTextarea');
        saveToLocalStorage(USER_NOTES_KEY, textarea.value);
        showNotification('Notes saved to local storage!', false, 'fas fa-save');
    }

    function updateClock() { 
        const clockEl = document.getElementById('clock');
        if (clockEl) {
            const now = new Date();
            const optionsDate = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: true };
            const formattedDate = now.toLocaleDateString('en-US', optionsDate); // e.g. Sun, Jun 8, 2025
            const formattedTime = now.toLocaleTimeString('en-US', optionsTime); // e.g. 03:24 PM
            clockEl.innerHTML = `<i class="far fa-calendar-alt"></i> ${formattedDate} | ${formattedTime}`;
        }
    }
    function filterBySearchAndTag() { 
        const searchInputEl = document.getElementById('searchInput');
        const searchTerm = (searchInputEl ? searchInputEl.value : '').toLowerCase();
        const activeFilterTag = document.querySelector('.filter-tag.active');
        const activeTagFilter = activeFilterTag ? activeFilterTag.dataset.filter : 'all';

        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            const isButtonVisibleByPermission = button.style.display !== 'none';
             if (!isButtonVisibleByPermission && !isUserAdmin()) return; // Already hidden by permissions for non-admin

            const btnTextSpan = button.querySelector('.btn-text');
            const buttonText = btnTextSpan ? btnTextSpan.textContent.toLowerCase() : '';
            const buttonTags = button.dataset.tags || '';

            const matchesSearch = searchTerm === '' || buttonText.includes(searchTerm);
            const matchesTag = activeTagFilter === 'all' || buttonTags.split(',').map(t=>t.trim()).includes(activeTagFilter);
            
            // If it passed permission/global state checks OR if admin is viewing, then apply search/tag
            if (isUserAdmin() || isButtonVisibleByPermission) {
                 button.style.display = (matchesSearch && matchesTag) ? 'flex' : 'none';
            }
        });
    }
    function filterByTagManual(tag) {
        document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
        const newActiveTag = document.querySelector(`.filter-tag[data-filter="${tag}"]`);
        if (newActiveTag) newActiveTag.classList.add('active');
        else { 
            const allTag = document.querySelector('.filter-tag[data-filter="all"]');
            if (allTag) allTag.classList.add('active');
        }
        applyButtonVisibility(); // This will re-apply permissions then search/tag filters
    }
    function initializeRecentLinks() { 
        const container = document.getElementById('recentLinksContainer');
        if (!isUserAdmin() || !container) { 
            if (container) container.innerHTML = '';
            return;
        }
        container.innerHTML = '';
        const links = getFromLocalStorage(RECENT_LINKS_KEY, []);
        if (links.length === 0) {
            container.innerHTML = '<p style="text-align:center; color: rgba(255,255,255,0.5);">No recently accessed links.</p>';
            return;
        }
        links.slice(0, 6).forEach(link => { 
            const item = document.createElement('div'); item.className = 'recent-item';
            item.innerHTML = `<div class="recent-icon"><i class="${link.icon || 'fas fa-link'}"></i></div>
                              <div class="recent-info"><h4>${link.title || 'Untitled Link'}</h4><p>Accessed ${formatTime(link.timestamp)}</p></div>`;
            item.onclick = () => window.open(link.url, '_blank');
            container.appendChild(item);
        });
    }
    function clearRecentLinks() {
        if (!isUserAdmin()) return;
        if (confirm("Are you sure you want to clear all recent links?")) {
            saveToLocalStorage(RECENT_LINKS_KEY, []);
            initializeRecentLinks();
            showNotification("Recent links cleared.", false, "fas fa-eraser");
        }
    }
    function formatTime(timestamp) { 
        const diff = new Date() - new Date(timestamp); 
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 1) return `${days} days ago`;
        if (days === 1) return `1 day ago`;
        if (hours > 1) return `${hours} hours ago`;
        if (hours === 1) return `1 hour ago`;
        if (minutes > 1) return `${minutes} mins ago`;
        if (minutes === 1) return `1 min ago`;
        return 'just now';
    }
    
    let trackedButtonListeners = new Map(); 

    function setupRecentLinkTracking() {
        // Remove all previous listeners to avoid duplicates on re-render
        trackedButtonListeners.forEach((listener, button) => {
            button.removeEventListener('click', listener);
        });
        trackedButtonListeners.clear();

        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            const buttonId = button.dataset.id;
            if (!buttonId) return;

            const listener = function(event) {
                if (isUserAdmin() && this.classList.contains('globally-disabled-admin-view')) {
                    if (!event.target.closest('.admin-toggle')) { 
                        event.preventDefault(); 
                        showNotification("Link globally disabled. Use admin toggle to enable.", true, "fas fa-ban"); 
                    }
                    return; 
                }
                if (this.style.display === 'none') { event.preventDefault(); return; } 

                const url = this.getAttribute('href');
                if (!url || url === '#') { 
                    if (this.target !== '_blank') event.preventDefault(); 
                     showNotification("This link is a placeholder.", false, "fas fa-info-circle");
                    return;
                }
                const titleSpan = this.querySelector('.btn-text');
                const title = titleSpan ? titleSpan.textContent.trim() : 'Unknown Link';
                const iconClass = this.querySelector('i:first-child') ? this.querySelector('i:first-child').className : 'fas fa-link';

                let links = getFromLocalStorage(RECENT_LINKS_KEY, []);
                links = links.filter(l => l.url !== url); 
                links.unshift({ url, title, icon: iconClass, timestamp: new Date().toISOString() });
                saveToLocalStorage(RECENT_LINKS_KEY, links.slice(0, 6)); 
                if (isUserAdmin()) initializeRecentLinks(); 
            };
            
            button.addEventListener('click', listener);
            trackedButtonListeners.set(button, listener);
        });
    }

    function setupBackToTopButton() {
        const btn = document.getElementById('backToTop');
        if(!btn) return;
        window.addEventListener('scroll', () => { btn.style.display = (window.scrollY > 300) ? 'flex' : 'none'; });
        btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
        document.getElementById('searchInput').addEventListener('input', filterBySearchAndTag);
        
        document.querySelectorAll('.filter-tag').forEach(tag => {
            tag.addEventListener('click', function() { filterByTagManual(this.dataset.filter); });
        });
        
        document.getElementById('loginPopup').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && (document.activeElement.id === 'username' || document.activeElement.id === 'password')) {
                validateLogin();
            }
        });
        
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
             modal.addEventListener('click', (event) => { 
                if (event.target == modal) {
                    switch(modal.id) {
                        case 'userManagementModal': closeUserManagementModal(); break;
                        case 'editDashboardModal': closeEditDashboardModal(); break;
                        case 'notepadModal': closeNotepadModal(); break;
                        case 'portalSettingsModal': closePortalSettingsModal(); break;
                    }
                }
            });
        });

        document.querySelectorAll('.overview-card .edit-card-btn').forEach(editBtn => {
            editBtn.addEventListener('click', function() {
                const cardId = this.closest('.overview-card').dataset.cardId;
                openEditDashboardModal(cardId);
            });
        });
        document.getElementById('particleToggle').addEventListener('change', toggleParticles);
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        saveToLocalStorage(PORTAL_DATA_VERSION_KEY, CURRENT_PORTAL_VERSION);
        initializeDefaultAdmin(); 
        
        loadThemeSettings(); 
        loadParticleSetting(); 
        
        renderAllButtons(); // This will create buttons, assign IDs, and apply visibility

        updateClock(); setInterval(updateClock, 30000); 
        setupBackToTopButton();
        setupEventListeners();
        
        applySectionVisibility(); 
        // loadGlobalButtonStatesForLoggedOutView(); // Covered by renderAllButtons
        // setupRecentLinkTracking(); // Called within renderAllButtons
        loadDashboardData(); 
    });

    window.addEventListener('resize', () => {
        if (!document.getElementById('particles').classList.contains('hidden')) {
            createParticles();
        }
    });

</script>
</body>
</html>
